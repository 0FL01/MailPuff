# MailPuff

Пересылка новых писем из IMAP в Telegram с безопасной ссылкой для просмотра HTML‑содержимого. Сообщения в Telegram не удаляются автоматически; HTML‑страница очищается из памяти по TTL или при превышении лимита просмотров.

## Как это работает
- Периодический опрос IMAP папки (по умолчанию `INBOX`).
- Парсинг письма: тема, отправитель, тело (`HTML` или безопасный `text/plain` → `<pre>`).
- Публикация HTML во встроенном in‑memory viewer с:
  - TTL (время жизни страницы),
  - ограничением числа просмотров.
- В Telegram отправляется сообщение с темой и кнопкой «Просмотреть письмо». Кнопка ведёт на `VIEWER_URL_BASE?id=...&token=...`.
- По истечении TTL или превышении просмотров страница удаляется из памяти (сообщение в Telegram остаётся доступным, но ссылка перестаёт открываться).

## Требования и запуск
Приложение рассчитано на запуск исключительно в Docker среде.

### Вариант 1: Docker Compose (рекомендуется)
1. Создайте файл `.env` (см. пример ниже).
2. Запустите:
```
docker compose up -d
```
3. Логи:
```
docker compose logs -f
```

### Вариант 2: Одиночный контейнер `docker run`
```
docker run -d \
  --name mailpuff \
  --restart unless-stopped \
  -p 8080:8080 \
  --env-file ./.env \
  -e TZ=${TZ:-UTC} \
  mailpuff:latest
```
> Примечание: образ `mailpuff:latest` можно собрать локально `docker build -t mailpuff:latest .` или публиковать в свой реестр.

## Переменные окружения
Обязательные:
- `IMAP_HOST`, `IMAP_USERNAME`, `IMAP_PASSWORD`
- `TELEGRAM_TOKEN`, `TELEGRAM_CHAT_ID` (int64)
- `VIEWER_URL_BASE` — полный базовый URL до `/view` (параметры `id`/`token` добавляются автоматически)

Опциональные (значения по умолчанию):
- `IMAP_PORT` (993), `IMAP_TLS` (true), `IMAP_MAILBOX` (INBOX)
- `IMAP_POLL_INTERVAL` (60s) — период опроса
- `IMAP_FORCE_RECONNECT` (60s) — дополнительный интервал для переборов соединения (внутренняя логика)
- `IMAP_MARK_SEEN` (false) — помечать письмо прочитанным при первом открытии HTML‑страницы по ссылке
- `HTTP_ADDR` (:8080) — адрес HTTP‑сервера viewer
- `VIEWER_PAGE_TTL` (48h) — срок жизни страницы
- `VIEWER_PAGE_MAX_VIEWS` (3) — лимит просмотров (<=0 — без ограничения)
- `TZ` — часовой пояс контейнера (например, `Europe/Moscow`)

## Пример `.env`
```
# IMAP
IMAP_HOST=imap.example.com
IMAP_PORT=993
IMAP_USERNAME=user@example.com
IMAP_PASSWORD=app-password
IMAP_TLS=true
IMAP_MAILBOX=INBOX
IMAP_POLL_INTERVAL=60s
IMAP_MARK_SEEN=false

# Telegram
TELEGRAM_TOKEN=123456:ABCDEF-your-bot-token
# Для групп/каналов часто отрицательное значение, например:
TELEGRAM_CHAT_ID=-1001234567890

# HTTP и Viewer
HTTP_ADDR=:8080
# Укажите полный базовый URL именно на путь /view
# Примеры:
#   локально:  http://localhost:8080/view
#   за прокси: https://mail.example.com/view
VIEWER_URL_BASE=http://localhost:8080/view
VIEWER_PAGE_TTL=48h
VIEWER_PAGE_MAX_VIEWS=3

# Часовой пояс внутри контейнера (опционально)
TZ=UTC
```

## Маршруты и поведение viewer
- HTTP‑сервер слушает `HTTP_ADDR` (по умолчанию `:8080`), в Docker пробрасывается на хост `8080:8080`.
- Основной маршрут: `/view?id=<UUID>&token=<TOKEN>` — возвращает HTML письма при валидном токене.
- Санитизация HTML: используется политика `UGC` из bluemonday для защиты от XSS; при отсутствии `HTML` содержимое `text/plain` заворачивается в безопасный `<pre>`.
- TTL и лимит просмотров: после первого успешного открытия счётчик увеличивается; при превышении лимита страница удаляется из памяти. По истечении TTL страница также удаляется.

## Типовые сценарии
- Изменить лимиты: укажите `VIEWER_PAGE_TTL` и/или `VIEWER_PAGE_MAX_VIEWS` в `.env`.
- Помечать письма прочитанными только при открытии: установите `IMAP_MARK_SEEN=true` — отметка произойдёт на событии первого открытия HTML.
- Работа через HTTPS: рекомендуем публиковать viewer за обратным прокси и выставить `VIEWER_URL_BASE` с `https`.

## Заметки безопасности
- `IMAP_TLS=true` настоятельно рекомендуется. При `IMAP_TLS=false` отключается проверка TLS‑сертификата соединения IMAP (небезопасно).
- Viewer хранит страницы в памяти процесса. При рестарте контейнера опубликованные страницы будут утрачены.

## Ограничения
- Дедупликация UID работает только в рамках одного запуска процесса; после рестарта те же письма могут быть обработаны повторно.
- Письма без `HTML` и `text/plain` будут пропущены (см. логи).

## Лицензия
MIT.
